<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>전국 시계탑 아카이브</title>
<style>
  :root {
    --bg: #0e0e0f; --fg: #e7e7ea; --muted:#9aa0a6; --line:#1f1f22;
    --accent:#7aa2ff; --chip:#1b1f2a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--fg); font:14px/1.6 system-ui, Apple SD Gothic Neo, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
  a{color:inherit; text-decoration:none}
  .app{display:grid; grid-template-columns:300px 1fr; min-height:100vh}
  .side{border-right:1px solid var(--line); padding:16px; position:sticky; top:0; height:100vh; overflow:auto}
  .brand{font-weight:700; letter-spacing:.2px; margin-bottom:12px}
  .search{display:flex; gap:8px; margin:8px 0 16px}
  .search input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#121215; color:var(--fg)}
  .view-toggle{display:flex; gap:6px; margin-bottom:12px}
  .btn{border:1px solid var(--line); background:#121215; color:var(--fg); padding:8px 10px; border-radius:10px; cursor:pointer}
  .btn.active{outline:2px solid var(--accent); border-color:transparent}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--line); cursor:pointer; color:var(--muted)}
  .chip.active{background:#1e293b; color:var(--fg); border-color:#334155}
  .reset{margin-top:10px; color:var(--muted); cursor:pointer; text-decoration:underline}

  .main{padding:16px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px}
  .card{background:#121215; border:1px solid var(--line); border-radius:14px; overflow:hidden}
  .thumb{aspect-ratio: 4/3; width:100%; object-fit:cover; display:block; background:#0a0a0b}
  .meta{padding:10px 12px}
  .title{font-weight:600; margin:0 0 4px}
  .note{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  /* Modal viewer */
  .modal{position:fixed; inset:0; display:none; background:rgba(0,0,0,.8); z-index:50}
  .modal.open{display:grid; grid-template-rows:auto 1fr auto}
  .modal-head, .modal-foot{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:rgba(20,20,24,.75); backdrop-filter:saturate(140%) blur(6px)}
  .modal-body{min-height:0; display:grid; place-items:center; padding:8px}
  .modal img{max-width:95vw; max-height:80vh; object-fit:contain}
  .kbd{font:12px/1 monospace; color:var(--muted)}
  .nav{display:flex; gap:6px}
  .hidden{display:none !important}

  /* mobile */
  @media (max-width: 900px){
    .app{grid-template-columns:1fr}
    .side{position:static; height:auto}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <aside class="side" aria-label="탐색">
    <div class="brand">전국 시계탑 아카이브</div>
    <div class="search" role="search">
      <input id="q" type="search" placeholder="검색: 제목·메모·태그" />
      <button class="btn" id="clear">지우기</button>
    </div>
    <div class="view-toggle" role="tablist" aria-label="보기">
      <button class="btn active" data-view="grid" aria-selected="true">그리드</button>
      <button class="btn" data-view="list" aria-selected="false">목록</button>
    </div>
    <div>
      <div style="margin:6px 0 8px; color:var(--muted)">태그</div>
      <div class="chips" id="chips"><!-- script가 채움 --></div>
      <div class="reset" id="resetFilters">필터 초기화</div>
    </div>
    <div style="margin-top:18px; color:var(--muted)" class="kbd">
      단축키: / 검색 · ←/→ 이전/다음 · Esc 닫기
    </div>
  </aside>

  <main class="main" aria-live="polite">
    <div id="grid" class="grid" role="list"></div>
    <div id="list" class="hidden" role="list"></div>
  </main>
</div>

<!-- 모달(이미지 뷰어) -->
<div class="modal" id="modal" aria-modal="true" role="dialog" aria-label="작품 뷰어">
  <div class="modal-head">
    <div id="mTitle"></div>
    <div class="nav">
      <button class="btn" id="prev" title="이전(←)">←</button>
      <button class="btn" id="next" title="다음(→)">→</button>
      <button class="btn" id="close" title="닫기(Esc)">닫기</button>
    </div>
  </div>
  <div class="modal-body">
    <img id="mImg" alt="" />
  </div>
  <div class="modal-foot">
    <div id="mNote" class="kbd"></div>
    <div class="kbd" id="mIndex"></div>
  </div>
</div>

<script>
/** =========================================
 *  데이터: 메타 최소화(제목, 이미지, 메모, 태그)
 *  - id: 고유 슬러그(딥링크/QR)
 *  - title: 카드 제목(지명·시설명 자유)
 *  - img: 원본 또는 대형 이미지 경로
 *  - thumb: 썸네일(없으면 img 사용)
 *  - note: 짧은 문장(현장 메모/상태 등 자유기술)
 *  - tags: 탐색용 태그(선택)
 *  ========================================= */
const ITEMS = [
  { id: "wonju-musil-park", title: "원주 무실 체육공원 시계탑", img: "/images/clock/wonju-musil-park.jpg", thumb: "/images/clock/wonju-musil-park_640.jpg", note: "생활체육 단지 입구. 야간 조명 약함.", tags:["생활체육","공원","강원"] },
  { id: "yanggu-rotary", title: "양구 로터리 시계", img: "/images/clock/yanggu-rotary.jpg", note:"도로 회전교차로 중앙. 차량 흐름 강함.", tags:["로터리","강원"] },
  { id: "danyang-susan", title: "단양 수산면 시계탑", img: "/images/clock/danyang-susan.jpg", note:"면사무소 인근. 작동 미확인.", tags:["관공서","충북"] },
  { id: "gangneung-univ", title: "강릉 ○○대 교정 시계", img: "/images/clock/gangneung-univ.jpg", note:"교정 중심부, 다면형.", tags:["학교","강원"] },
  // ... 필요 수 만큼 이어서 추가
];

/* -------- 상태 -------- */
let state = {
  q: new URLSearchParams(location.search).get("q") || "",
  tag: new URLSearchParams(location.search).get("tag") || "",
  view: new URLSearchParams(location.search).get("view") || "grid",
  currentIndex: -1
};

/* -------- 유틸 -------- */
const $ = (sel, el=document)=>el.querySelector(sel);
const $$ = (sel, el=document)=>Array.from(el.querySelectorAll(sel));
const setQS = (obj)=>{
  const p = new URLSearchParams(location.search);
  for(const [k,v] of Object.entries(obj)){
    if(v===undefined||v===null||v==="") p.delete(k); else p.set(k,v);
  }
  const url = location.pathname + "?" + p.toString();
  history.replaceState(null,"",url);
};

/* -------- 태그 수집 -------- */
const ALL_TAGS = Array.from(new Set(ITEMS.flatMap(it=>it.tags||[]))).sort();

/* -------- 렌더: 태그칩 -------- */
function renderChips(){
  const box = $("#chips");
  box.innerHTML = "";
  ALL_TAGS.forEach(t=>{
    const b = document.createElement("button");
    b.className = "chip" + (state.tag===t?" active":"");
    b.textContent = t;
    b.setAttribute("aria-pressed", state.tag===t ? "true":"false");
    b.onclick = ()=>{
      state.tag = (state.tag===t) ? "" : t;
      setQS({tag: state.tag});
      render();
    };
    box.appendChild(b);
  });
}

/* -------- 필터링 -------- */
function applyFilter(){
  let out = ITEMS.slice();
  if(state.q){
    const q = state.q.toLowerCase();
    out = out.filter(it=>{
      return (it.title||"").toLowerCase().includes(q)
          || (it.note||"").toLowerCase().includes(q)
          || (it.tags||[]).some(x=>x.toLowerCase().includes(q));
    });
  }
  if(state.tag){
    out = out.filter(it=>(it.tags||[]).includes(state.tag));
  }
  return out;
}

/* -------- 카드/목록 -------- */
function card(it){
  const li = document.createElement("article");
  li.className="card";
  li.setAttribute("role","listitem");
  const img = document.createElement("img");
  img.className="thumb";
  img.loading="lazy";
  img.alt = it.title || "";
  img.src = it.thumb || it.img;
  img.decoding = "async";
  img.onclick = ()=>openModalById(it.id);
  const meta = document.createElement("div");
  meta.className="meta";
  meta.innerHTML = `<h3 class="title">${it.title||"Untitled"}</h3><div class="note">${it.note||""}</div>`;
  li.appendChild(img); li.appendChild(meta);
  li.addEventListener("click", e=>{
    // 이미지 외 영역 클릭도 열기
    if(e.target.tagName !== "IMG") openModalById(it.id);
  });
  return li;
}
function row(it){
  const div = document.createElement("div");
  div.className="card";
  const meta = document.createElement("div");
  meta.className="meta";
  meta.innerHTML = `<h3 class="title">${it.title||"Untitled"}</h3>
    <div class="note">${(it.tags||[]).join(" · ")}${(it.note? " — "+it.note:"")}</div>`;
  div.appendChild(meta);
  div.addEventListener("click", ()=>openModalById(it.id));
  return div;
}

/* -------- 렌더 전체 -------- */
function render(){
  $("#q").value = state.q;
  $$(".view-toggle .btn").forEach(b=>{
    const active = b.dataset.view===state.view;
    b.classList.toggle("active", active);
    b.setAttribute("aria-selected", active?"true":"false");
  });

  const data = applyFilter();
  const grid = $("#grid"), list=$("#list");
  grid.classList.toggle("hidden", state.view!=="grid");
  list.classList.toggle("hidden", state.view!=="list");
  grid.innerHTML = ""; list.innerHTML="";

  if(state.view==="grid"){
    data.forEach(it=> grid.appendChild(card(it)));
  }else{
    data.forEach(it=> list.appendChild(row(it)));
  }
  renderChips();

  // 모달 내 현재 인덱스 재정렬
  if(state.currentIndex>=0){
    const id = ITEMS[state.currentIndex]?.id;
    const idx = data.findIndex(x=>x.id===id);
    if(idx===-1) closeModal();
  }
}

/* -------- 모달 -------- */
const modal = $("#modal"), mImg=$("#mImg"), mTitle=$("#mTitle"), mNote=$("#mNote"), mIndex=$("#mIndex");
function openModalById(id){
  const data = applyFilter();
  const idx = data.findIndex(it=>it.id===id);
  if(idx<0 && data.length) return openModalIndex(0);
  openModalIndex(idx, data);
}
function openModalIndex(idx, data = applyFilter()){
  const it = data[idx];
  if(!it) return;
  state.currentIndex = ITEMS.findIndex(x=>x.id===it.id); // 전역 인덱스 유지
  mImg.src = it.img;
  mImg.alt = it.title||"";
  mTitle.textContent = it.title||"";
  mNote.textContent = it.note||"";
  mIndex.textContent = `${idx+1} / ${data.length}`;
  modal.classList.add("open");
  document.body.style.overflow = "hidden";
  // 해시/쿼리로 딥링크
  setQS({id: it.id});
}
function closeModal(){
  modal.classList.remove("open");
  document.body.style.overflow = "";
  state.currentIndex = -1;
  setQS({id:""});
}
function nextItem(step=1){
  const data = applyFilter();
  if(!data.length) return;
  const curId = new URLSearchParams(location.search).get("id");
  let idx = Math.max(0, data.findIndex(it=>it.id===curId));
  idx = (idx + step + data.length) % data.length;
  openModalById(data[idx].id);
}

/* -------- 초기화 -------- */
function init(){
  // 검색
  $("#q").addEventListener("input", (e)=>{
    state.q = e.target.value;
    setQS({q: state.q});
    render();
  });
  $("#clear").onclick = ()=>{ state.q=""; setQS({q:""}); render(); };
  // 보기 토글
  $$(".view-toggle .btn").forEach(b=>{
    b.onclick = ()=>{ state.view = b.dataset.view; setQS({view: state.view}); render(); };
  });
  // 필터 초기화
  $("#resetFilters").onclick = ()=>{ state.tag=""; state.q=""; setQS({q:"", tag:""}); render(); };

  // 단축키
  window.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#q").focus(); $("#q").select(); }
    if(e.key==="Escape") closeModal();
    if(e.key==="ArrowRight") nextItem(1);
    if(e.key==="ArrowLeft") nextItem(-1);
  });

  // URL 파라미터로 모달 직행(QR 라벨 연결)
  const id = new URLSearchParams(location.search).get("id");
  if(id) openModalById(id);

  render();
}
init();
  
// 모달 버튼
$("#close").onclick = closeModal;
$("#next").onclick = ()=>nextItem(1);
$("#prev").onclick = ()=>nextItem(-1);
</script>
</body>
</html>
